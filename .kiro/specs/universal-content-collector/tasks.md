# 实施计划: 全渠道内容收藏助手

## 概述

本实施计划将全渠道内容收藏助手分解为可执行的开发任务。系统采用前后端分离架构，使用TypeScript开发，包含链接解析、元数据提取、内容管理和搜索等核心功能。任务按照依赖关系组织，确保每个步骤都能在前一步的基础上构建。

## 任务列表

- [x] 1. 项目初始化和基础设施搭建
  - 创建前端项目（React + TypeScript + Vite）
  - 创建后端项目（Node.js + Express + TypeScript）
  - 配置PostgreSQL数据库连接
  - 配置Redis缓存连接
  - 设置ESLint和Prettier代码规范
  - 配置测试框架（Jest + fast-check）
  - _需求: 所有需求的基础_

- [x] 2. 数据库Schema和模型层实现
  - [x] 2.1 创建数据库迁移脚本
    - 实现users、folders、content_items、tags、content_tags表的创建脚本
    - 添加索引和约束
    - 实现全文搜索的tsvector配置
    - _需求: 8.1, 8.4_
  
  - [x] 2.2 实现数据模型和ORM映射
    - 使用TypeORM或Prisma定义实体模型
    - 实现User、Folder、ContentItem、Tag模型
    - 配置关联关系（一对多、多对多）
    - _需求: 3.1, 4.1, 8.1_
  
  - [ ]* 2.3 编写数据模型的属性测试
    - **属性 4: 内容项数据完整性**
    - **验证需求: 2.4, 2.5**

- [x] 3. 链接解析器实现
  - [x] 3.1 实现LinkParser核心逻辑
    - 实现平台URL模式匹配（微信、知乎、小红书、抖音、B站）
    - 实现parse方法返回ParseResult
    - 处理无效URL和不支持平台的情况
    - _需求: 1.1, 1.3, 1.4_
  
  - [ ]* 3.2 编写LinkParser的属性测试
    - **属性 1: 链接平台识别正确性**
    - **验证需求: 1.1**
  
  - [ ]* 3.3 编写LinkParser的属性测试
    - **属性 2: 无效链接错误处理**
    - **验证需求: 1.4**
  
  - [ ]* 3.4 编写LinkParser的单元测试
    - 测试每个支持平台的示例链接
    - 测试边界情况（空字符串、特殊字符）
    - _需求: 1.3_

- [-] 4. 元数据提取器实现
  - [x] 4.1 实现MetadataExtractor核心逻辑
    - 使用axios发送HTTP请求
    - 使用cheerio解析HTML
    - 提取Open Graph标签（og:title, og:description, og:image）
    - 实现降级策略（HTML meta标签）
    - 实现超时和重试机制
    - _需求: 2.1, 2.2, 2.3_
  
  - [ ]* 4.2 编写MetadataExtractor的属性测试
    - **属性 3: 元数据提取完整性**
    - **验证需求: 2.1, 2.4**
  
  - [ ]* 4.3 编写MetadataExtractor的单元测试
    - 测试成功提取场景
    - 测试提取失败的降级策略
    - 模拟网络超时
    - _需求: 2.3_

- [-] 5. 收藏服务实现
  - [x] 5.1 实现CollectionService
    - 实现create方法（创建收藏）
    - 实现update方法（更新收藏）
    - 实现delete方法（删除收藏）
    - 实现get方法（获取收藏详情）
    - 实现moveToFolder方法（移动到文件夹）
    - _需求: 2.1, 2.4, 2.5, 3.5_
  
  - [ ]* 5.2 编写CollectionService的属性测试
    - **属性 5: 文件夹移动操作正确性**
    - **验证需求: 3.5**
  
  - [ ]* 5.3 编写CollectionService的属性测试
    - **属性 13: 数据持久化一致性**
    - **验证需求: 8.1**

- [x] 6. 文件夹服务实现
  - [x] 6.1 实现FolderService
    - 实现create方法（创建文件夹）
    - 实现update方法（更新文件夹）
    - 实现delete方法（删除文件夹，支持级联删除选项）
    - 实现getTree方法（获取文件夹树）
    - 实现getContents方法（获取文件夹内容，支持分页）
    - 创建默认"未分类"文件夹
    - _需求: 3.1, 3.2, 3.3, 3.4_
  
  - [ ]* 6.2 编写FolderService的单元测试
    - 测试多级文件夹创建（至少3层）
    - 测试删除包含内容的文件夹
    - 测试默认文件夹的创建
    - _需求: 3.2, 3.3, 3.4_

- [-] 7. 标签服务实现
  - [x] 7.1 实现TagService
    - 实现create方法（创建标签）
    - 实现rename方法（重命名标签）
    - 实现delete方法（删除标签）
    - 实现getAll方法（获取所有标签）
    - 实现addToContent方法（为内容添加标签）
    - 实现removeFromContent方法（从内容移除标签）
    - 实现getContentCount方法（获取标签的内容数量）
    - _需求: 4.1, 4.2, 4.4, 4.5_
  
  - [ ]* 7.2 编写TagService的属性测试
    - **属性 6: 标签关联正确性**
    - **验证需求: 4.1**
  
  - [ ]* 7.3 编写TagService的属性测试
    - **属性 7: 标签内容计数准确性**
    - **验证需求: 4.4**
  
  - [ ]* 7.4 编写TagService的属性测试
    - **属性 8: 标签删除级联正确性**
    - **验证需求: 4.5**

- [-] 8. 搜索服务实现
  - [x] 8.1 实现SearchService
    - 实现search方法支持关键词搜索
    - 实现平台筛选
    - 实现时间范围筛选
    - 实现内容类型筛选
    - 实现标签筛选
    - 实现组合筛选条件
    - 实现排序功能（按时间、标题）
    - 实现分页功能
    - 集成Redis缓存热门搜索结果
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.7, 6.4, 9.5_
  
  - [ ]* 8.2 编写SearchService的属性测试
    - **属性 9: 关键词搜索准确性**
    - **验证需求: 5.1**
  
  - [ ]* 8.3 编写SearchService的属性测试
    - **属性 10: 筛选条件正确性**
    - **验证需求: 5.2, 5.3, 5.4, 5.5, 5.7**
  
  - [ ]* 8.4 编写SearchService的属性测试
    - **属性 12: 排序结果有序性**
    - **验证需求: 6.4**
  
  - [ ]* 8.5 编写SearchService的属性测试
    - **属性 15: 分页参数正确性**
    - **验证需求: 9.5**

- [ ] 9. 检查点 - 后端核心服务验证
  - 确保所有后端服务测试通过
  - 验证数据库操作正确性
  - 如有问题请向用户询问

- [x] 10. REST API端点实现
  - [x] 10.1 实现收藏相关API
    - POST /api/collections - 创建收藏
    - PUT /api/collections/:id - 更新收藏
    - DELETE /api/collections/:id - 删除收藏
    - GET /api/collections/:id - 获取收藏详情
    - POST /api/collections/:id/move - 移动到文件夹
    - _需求: 2.1, 2.4, 2.5, 3.5_
  
  - [x] 10.2 实现文件夹相关API
    - POST /api/folders - 创建文件夹
    - PUT /api/folders/:id - 更新文件夹
    - DELETE /api/folders/:id - 删除文件夹
    - GET /api/folders/tree - 获取文件夹树
    - GET /api/folders/:id/contents - 获取文件夹内容
    - _需求: 3.1, 3.2, 3.3, 3.4_
  
  - [x] 10.3 实现标签相关API
    - POST /api/tags - 创建标签
    - PUT /api/tags/:id - 重命名标签
    - DELETE /api/tags/:id - 删除标签
    - GET /api/tags - 获取所有标签
    - POST /api/contents/:id/tags - 为内容添加标签
    - DELETE /api/contents/:id/tags - 从内容移除标签
    - _需求: 4.1, 4.2, 4.4, 4.5_
  
  - [x] 10.4 实现搜索API
    - GET /api/search - 搜索和筛选内容
    - 支持查询参数：keyword, platforms, tags, contentType, dateRange, sortBy, page, pageSize
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.7, 6.4, 9.5_
  
  - [x] 10.5 实现链接解析API
    - POST /api/parse - 解析链接并提取元数据
    - 返回ParseResult和ContentMetadata
    - _需求: 1.1, 1.3, 1.4, 2.1_
  
  - [ ]* 10.6 编写API集成测试
    - 测试完整的收藏流程
    - 测试搜索和筛选功能
    - 测试错误处理
    - _需求: 所有需求_

- [x] 11. 错误处理和日志记录
  - [x] 11.1 实现统一错误处理中间件
    - 定义ErrorResponse格式
    - 处理各类错误（解析错误、数据库错误、网络错误）
    - 返回友好的错误消息
    - _需求: 10.1, 10.2, 10.3, 10.4_
  
  - [x] 11.2 实现日志记录系统
    - 使用Winston或Pino记录日志
    - 记录所有错误和关键操作
    - 包含用户ID、请求上下文、时间戳
    - _需求: 10.4_
  
  - [ ]* 11.3 编写错误处理的属性测试
    - **属性 16: 错误日志记录完整性**
    - **验证需求: 10.4**

- [ ] 12. 前端基础组件实现
  - [x] 12.1 实现ClipboardMonitor组件
    - 使用Clipboard API监听剪贴板
    - 检测支持平台的链接
    - 实现防抖处理
    - 处理权限请求
    - _需求: 1.1, 1.2_
  
  - [x] 12.2 实现CollectionDialog组件
    - 显示收藏确认界面
    - 支持选择文件夹
    - 支持添加标签
    - 支持手动编辑标题和摘要
    - _需求: 1.2, 2.3_
  
  - [x] 12.3 实现ContentCard组件
    - 渲染内容卡片（封面图、标题、作者、平台图标、时间）
    - 处理点击事件
    - 处理右键菜单
    - 实现加载失败的占位图
    - _需求: 6.1, 6.2, 6.5_
  
  - [ ]* 12.4 编写ContentCard的属性测试
    - **属性 11: 内容卡片渲染完整性**
    - **验证需求: 6.2**

- [ ] 13. 前端内容管理界面
  - [ ] 13.1 实现文件夹树组件
    - 显示多级文件夹结构
    - 支持展开/折叠
    - 支持拖拽移动内容
    - 显示文件夹内容数量
    - _需求: 3.1, 3.2_
  
  - [ ] 13.2 实现内容列表组件
    - 支持列表视图和瀑布流视图切换
    - 实现虚拟滚动优化性能
    - 支持分页加载
    - 显示加载指示器
    - _需求: 6.1, 6.3, 9.4, 9.5_
  
  - [ ] 13.3 实现标签管理组件
    - 显示所有标签和内容数量
    - 支持创建、重命名、删除标签
    - 支持标签筛选
    - 实现标签自动补全
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 14. 前端搜索和筛选功能
  - [ ] 14.1 实现搜索栏组件
    - 实现关键词搜索输入
    - 实现实时搜索（防抖）
    - 显示搜索结果数量
    - _需求: 5.1, 5.6_
  
  - [ ] 14.2 实现筛选面板组件
    - 实现平台筛选（多选）
    - 实现时间范围筛选（日期选择器）
    - 实现内容类型筛选（单选）
    - 实现标签筛选（多选）
    - 实现排序选项（时间/标题，升序/降序）
    - 支持组合多个筛选条件
    - _需求: 5.2, 5.3, 5.4, 5.5, 5.7, 6.4_

- [ ] 15. 前端内容查看器实现
  - [ ] 15.1 实现ContentViewer组件
    - 实现Webview预览功能
    - 实现Deep Link跳转功能
    - 实现降级策略（Deep Link失败时使用Webview）
    - 实现浏览器控制（前进、后退、刷新）
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [ ]* 15.2 编写ContentViewer的单元测试
    - 测试Webview加载
    - 测试Deep Link降级策略
    - _需求: 7.4_

- [ ] 16. 检查点 - 前端核心功能验证
  - 确保所有前端组件正常渲染
  - 验证与后端API的集成
  - 测试用户交互流程
  - 如有问题请向用户询问

- [ ] 17. 数据同步和缓存实现
  - [ ] 17.1 实现缓存管理器
    - 使用Redis缓存搜索结果
    - 实现缓存失效策略（TTL 5分钟）
    - 缓存热门查询
    - _需求: 5.1, 9.3_
  
  - [ ] 17.2 实现本地存储
    - 使用IndexedDB缓存内容数据
    - 实现离线浏览功能
    - 实现网络恢复后的自动同步
    - _需求: 8.2, 8.3_
  
  - [ ]* 17.3 编写并发操作的属性测试
    - **属性 14: 并发操作数据一致性**
    - **验证需求: 8.4**

- [ ] 18. 用户认证和授权
  - [ ] 18.1 实现用户注册和登录
    - 实现JWT token认证
    - 实现密码哈希（bcrypt）
    - 实现token刷新机制
    - _需求: 所有需求的前提_
  
  - [ ] 18.2 实现认证中间件
    - 验证JWT token
    - 处理token过期
    - 实现权限检查
    - _需求: 所有需求的前提_
  
  - [ ]* 18.3 编写认证功能的单元测试
    - 测试注册和登录流程
    - 测试token验证
    - 测试权限检查

- [ ] 19. 性能优化
  - [ ] 19.1 优化数据库查询
    - 添加必要的索引
    - 优化N+1查询问题
    - 实现查询结果缓存
    - _需求: 9.1, 9.2, 9.3_
  
  - [ ] 19.2 优化前端性能
    - 实现图片懒加载
    - 实现代码分割
    - 优化打包体积
    - 实现Service Worker缓存
    - _需求: 9.1, 9.2_

- [ ] 20. 端到端测试和部署准备
  - [ ]* 20.1 编写端到端测试
    - 测试完整的收藏流程
    - 测试搜索和筛选流程
    - 测试文件夹和标签管理
    - _需求: 所有需求_
  
  - [ ] 20.2 准备部署配置
    - 配置生产环境变量
    - 配置数据库迁移脚本
    - 配置CI/CD流程
    - 编写部署文档

- [ ] 21. 最终检查点
  - 确保所有测试通过（单元测试、属性测试、集成测试）
  - 验证所有需求都已实现
  - 检查代码质量和测试覆盖率
  - 如有问题请向用户询问

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
