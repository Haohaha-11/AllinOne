import { useState, useEffect } from 'react';
import { ClipboardMonitor } from './components/ClipboardMonitor';
import { CollectionDialog } from './components/CollectionDialog';
import { ContentCard } from './components/ContentCard';

function App() {
  const [showDialog, setShowDialog] = useState(false);
  const [detectedUrl, setDetectedUrl] = useState('');
  const [collections, setCollections] = useState<any[]>([]);
  const [showPasteDialog, setShowPasteDialog] = useState(false);
  const [showFolderDialog, setShowFolderDialog] = useState(false);
  const [manualUrl, setManualUrl] = useState('');
  const [newFolderName, setNewFolderName] = useState('');
  const [loading, setLoading] = useState(false);

  // åŠ è½½æ”¶è—åˆ—è¡¨
  useEffect(() => {
    loadCollections();
  }, []);

  const loadCollections = async () => {
    try {
      const response = await fetch('http://localhost:5000/api/collections?userId=550e8400-e29b-41d4-a716-446655440000');
      if (response.ok) {
        const data = await response.json();
        setCollections(data);
      }
    } catch (error) {
      console.error('åŠ è½½æ”¶è—å¤±è´¥:', error);
    }
  };

  const handleLinkDetected = (url: string) => {
    setDetectedUrl(url);
    setShowDialog(true);
  };

  const handleConfirm = async (data: any) => {
    setLoading(true);
    try {
      console.log('å‘é€æ”¶è—è¯·æ±?', data);
      const response = await fetch('http://localhost:5000/api/collections', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url: data.url,
          userId: '550e8400-e29b-41d4-a716-446655440000',
          customTitle: data.title,
          customDescription: data.description,
          folderId: data.folderId || null,
        }),
      });

      const responseData = await response.json();
      console.log('æ”¶è—å“åº”:', responseData);

      if (response.ok) {
        setCollections([responseData, ...collections]);
        setShowDialog(false);
        setShowPasteDialog(false);
        setManualUrl('');
        alert('âœ?æ”¶è—æˆåŠŸï¼?);
        await loadCollections();
      } else {
        console.error('æ”¶è—å¤±è´¥:', responseData);
        alert(`â?æ”¶è—å¤±è´¥: ${responseData.error || 'è¯·é‡è¯?}`);
      }
    } catch (error) {
      console.error('æ”¶è—å¤±è´¥:', error);
      alert('â?æ”¶è—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡');
    } finally {
      setLoading(false);
    }
  };

  const handleManualPaste = () => {
    if (manualUrl.trim()) {
      setDetectedUrl(manualUrl);
      setShowDialog(true);
      setShowPasteDialog(false);
    } else {
      alert('è¯·è¾“å…¥é“¾æ?);
    }
  };

  const handleCreateFolder = async () => {
    if (!newFolderName.trim()) {
      alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
      return;
    }

    setLoading(true);
    try {
      const response = await fetch('http://localhost:5000/api/folders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: newFolderName,
          userId: '550e8400-e29b-41d4-a716-446655440000',
        }),
      });

      if (response.ok) {
        const folder = await response.json();
        alert(`âœ?æ–‡ä»¶å¤?"${folder.name}" åˆ›å»ºæˆåŠŸï¼`);
        setShowFolderDialog(false);
        setNewFolderName('');
      } else {
        const error = await response.json();
        alert(`â?åˆ›å»ºå¤±è´¥: ${error.error || 'è¯·é‡è¯?}`);
      }
    } catch (error) {
      console.error('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´?', error);
      alert('â?åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="app">
      <ClipboardMonitor onLinkDetected={handleLinkDetected} />

      {/* é¡¶éƒ¨å¯¼èˆªæ ?*/}
      <nav className="navbar">
        <div className="navbar-brand">
          <h1>All in One</h1>
        </div>
        <div className="navbar-actions">
          <button className="btn btn-secondary" onClick={() => setShowFolderDialog(true)}>
            ï¿?æ–°å»ºæ”¶è—å¤?
          </button>
          <button className="btn btn-primary" onClick={() => setShowPasteDialog(true)}>
            ï¿?ç²˜è´´é“¾æ¥
          </button>
          <button className="btn btn-secondary" onClick={loadCollections}>
            ğŸ”„ åˆ·æ–°åˆ—è¡¨
          </button>
        </div>
      </nav>

      {/* ä¸»å†…å®¹åŒº */}
      <div className="main-content">
        {/* æ”¶è—ç»Ÿè®¡ */}
        <div className="stats-bar">
          <div className="stat-item">
            <span className="stat-number">{collections.length}</span>
            <span className="stat-label">æ”¶è—æ€»æ•°</span>
          </div>
          <div className="stat-item">
            <span className="stat-number">5</span>
            <span className="stat-label">æ”¯æŒå¹³å°</span>
          </div>
        </div>

        {/* æ”¶è—åˆ—è¡¨ - ä¹¦æ¶å¼å±•ç¤?*/}
        {collections.length > 0 ? (
          <div className="bookshelf">
            <h2 className="section-title">æˆ‘çš„æ”¶è—</h2>
            <div className="bookshelf-grid">
              {collections.map((item: any) => (
                <ContentCard
                  key={item.id}
                  item={item}
                  onClick={(clickedItem) => window.open(clickedItem.url, '_blank')}
                />
              ))}
            </div>
          </div>
        ) : (
          <div className="empty-state">
            <div className="empty-icon">ğŸ“–</div>
            <h2>ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</h2>
            <p>å¤åˆ¶é“¾æ¥æˆ–ç‚¹å‡?ç²˜è´´é“¾æ¥"æŒ‰é’®å¼€å§‹æ”¶è—?/p>
            <button className="btn btn-large btn-primary" onClick={() => setShowPasteDialog(true)}>
              ğŸ“ å¼€å§‹æ”¶è—?
            </button>
          </div>
        )}
      </div>

      {/* æ”¶è—å¯¹è¯æ¡?*/}
      {showDialog && (
        <CollectionDialog
          url={detectedUrl}
          onConfirm={handleConfirm}
          onCancel={() => {
            setShowDialog(false);
            setManualUrl('');
          }}
        />
      )}

      {/* æ‰‹åŠ¨ç²˜è´´å¯¹è¯æ¡?*/}
      {showPasteDialog && (
        <div className="dialog-overlay">
          <div className="dialog">
            <h2>ç²˜è´´é“¾æ¥</h2>
            <p>æ”¯æŒï¼šçŸ¥ä¹ã€å¾®ä¿¡å…¬ä¼—å·ã€å°çº¢ä¹¦ã€æŠ–éŸ³ã€Bç«?/p>
            <div className="form-group">
              <input
                type="text"
                placeholder="ç²˜è´´é“¾æ¥åˆ°è¿™é‡?.."
                value={manualUrl}
                onChange={(e) => setManualUrl(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleManualPaste()}
                autoFocus
              />
            </div>
            <div className="dialog-actions">
              <button onClick={() => setShowPasteDialog(false)}>å–æ¶ˆ</button>
              <button onClick={handleManualPaste} disabled={!manualUrl.trim()}>
                ç¡®è®¤
              </button>
            </div>
          </div>
        </div>
      )}

      {/* æ–°å»ºæ–‡ä»¶å¤¹å¯¹è¯æ¡† */}
      {showFolderDialog && (
        <div className="dialog-overlay">
          <div className="dialog">
            <h2>æ–°å»ºæ”¶è—å¤?/h2>
            <p>åˆ›å»ºä¸€ä¸ªæ–°çš„æ”¶è—å¤¹æ¥ç»„ç»‡ä½ çš„å†…å®?/p>
            <div className="form-group">
              <label>æ–‡ä»¶å¤¹åç§?/label>
              <input
                type="text"
                placeholder="ä¾‹å¦‚ï¼šæŠ€æœ¯æ–‡ç« ã€è®¾è®¡çµæ„?.."
                value={newFolderName}
                onChange={(e) => setNewFolderName(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleCreateFolder()}
                autoFocus
              />
            </div>
            <div className="dialog-actions">
              <button onClick={() => {
                setShowFolderDialog(false);
                setNewFolderName('');
              }}>å–æ¶ˆ</button>
              <button onClick={handleCreateFolder} disabled={!newFolderName.trim()}>
                åˆ›å»º
              </button>
            </div>
          </div>
        </div>
      )}

      {/* åŠ è½½æŒ‡ç¤ºå™?*/}
      {loading && (
        <div className="loading-overlay">
          <div className="loading-spinner">åŠ è½½ä¸?..</div>
        </div>
      )}
    </div>
  );
}

export default App;
